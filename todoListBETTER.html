<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="toDoStyle.css">
  <title>To Do List</title>
</head>

<body>
  <h1>To Do List :3 </h1>
  <div id="container"></div>
  <br />
  <button type="submit" class="button" id="addButton" style="margin-top: 10px; margin-left: 1.3rem;">+</button>


</body>

<script type="module">

  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
  const firebaseConfig = {
    apiKey: "AIzaSyCDsIup2KaJeQMPL5jvCMzMA7RTpPiPg7o",
    authDomain: "tomotaru-bb27a.firebaseapp.com",
    databaseURL: "https://tomotaru-bb27a-default-rtdb.firebaseio.com",
    projectId: "tomotaru-bb27a",
    storageBucket: "tomotaru-bb27a.appspot.com",
    messagingSenderId: "281838524572",
    appId: "1:281838524572:web:ee113e29d661a9c1a73559",
    measurementId: "G-9HY07GMSFH"
  };
  const app = initializeApp(firebaseConfig);
  import { getDatabase, set, get, update, remove, ref, child, push }
    from "https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js";
  const db = getDatabase();
  const auth = getAuth();

  import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
  var items = [];
  var addButton = document.getElementById("addButton");
  addButton.addEventListener('click', () => {
    generateItems(null, items.length + 1);
    items.push(items.length + 1);
  });




  function generateItems(text, id) {
    const container = document.getElementById("container");
    const toDoDiv = document.createElement('div');
    toDoDiv.style = "display: flex; margin-left: 1rem;";
    if (text == null) {
      toDoDiv.innerHTML = `
          <input type="checkbox" id="cb-${id}" class="cb" class="cbStyle">
          <input type="text" placeholder="Untitled" id="tb-${id}" class="tb">
          `;
    }
    else {
      toDoDiv.innerHTML = `
          <input type="checkbox" id="cb-${id}" class="cb" class="cbStyle">
          <input type="text" value="${text}" id="tb-${id}" class="tb">
          `;
    }
    container.appendChild(toDoDiv);
    const checker = document.getElementById(`cb-${id}`);
    const typer = document.getElementById(`tb-${id}`);
    checker.addEventListener('click', () => {
      deleteItem(checker, checker.id.substring(3));
    })
    typer.addEventListener('focusout', () => {

      save(typer.value, typer.id.substring(3));
    })
  }


  function deleteItem(element, id) {
    var user = auth.currentUser;
    
    console.log("deleted");
    remove(ref(db, "User/" + "lizzy m" + "/toDoList/" + id));
    
    reorderDB(element, id);
  }


  function reorderDB(element, id) {
    console.log("reordered");
    console.log(items);
    let num = items.length;
    items.splice(id, 1);
    console.log(id);
    console.log(items.length);
    
    for (let i = id; i <= num; i++) {
      let thing1 = document.getElementById(`cb-${i}`);
      let thing2 = document.getElementById(`tb-${i}`);
      
      thing1.id = `cb-${thing1.id.slice(3) - 1}`;
      thing2.id = `tb-${thing2.id.slice(3) - 1}`;
      if(items[i]){
        items[i] -= 1;
      }
    }
    console.log(items);
    element.parentElement.remove();
    updateFirebase();

  }


  function save(text, id) {
    console.log("saving");
    console.log(id);
    var user = auth.currentUser;
    id = (id).toString();

    set(ref(db, "User/" + "lizzy m" + "/toDoList/" + id), {
      Item: text
    });
    updateFirebase();
    console.log(items);
  }


  function updateFirebase() {
    let lower = 0;
    let higher = 0;

    get(ref(db, "User/lizzy m/toDoList"))
      .then((snapshot) => {
        if (snapshot.exists()) {
          let newPosition = 1; // Start storing at position 1
          const updates = {}; // Collect updates for repositioning
          const oldKeys = []; // Track old keys to remove
          snapshot.forEach((childSnapshot) => {
            const value = childSnapshot.val();
            const key = childSnapshot.key;
            higher++;
            // If the item exists and is valid, reposition it
            if (value && value.Item !== null && value.Item !== "") {
              updates[newPosition] = { Item: value.Item }; // New position data
              if (parseInt(key) !== newPosition) {
                console.log("here");
                oldKeys.push(key); // Track the key only if it needs to be replaced
              }
              console.log(`Moved item from ${key} to ${newPosition}`);
              lower++;
              newPosition++;
            } else {
              // If the item is invalid or empty, add it to the oldKeys for removal
              console.log("there");
              oldKeys.push(key);
            }
          });
          return update(ref(db, "User/lizzy m/toDoList"), updates).then(() => {
            return oldKeys
          });
        }
      })
      .then((oldKeys) => {
        // Remove old keys
        if (oldKeys) {
          if ((oldKeys.length != 1) && (oldKeys[higher - lower] != lower)) {
            oldKeys.shift();
            console.log("shifted");
          }

          if (oldKeys.length > 0) {
            const removalPromises = oldKeys.map((key) =>
              remove(ref(db, `User/lizzy m/toDoList/${key}`))
            );
            return Promise.all(removalPromises);
          }

        }
      })

  }


  function PageLoad() {
    let lower = 0;
    let higher = 0;

    get(ref(db, "User/lizzy m/toDoList"))
      .then((snapshot) => {
        if (snapshot.exists()) {
          let newPosition = 1; // Start storing at position 1
          const updates = {}; // Collect updates for repositioning
          const oldKeys = []; // Track old keys to remove
          snapshot.forEach((childSnapshot) => {
            const value = childSnapshot.val();
            const key = childSnapshot.key;
            higher++;
            // If the item exists and is valid, reposition it
            if (value && value.Item !== null && value.Item !== "") {
              updates[newPosition] = { Item: value.Item }; // New position data
              if (parseInt(key) !== newPosition) {
                console.log("here");
                oldKeys.push(key); // Track the key only if it needs to be replaced
              }
              console.log(`Moved item from ${key} to ${newPosition}`);
              lower++;
              newPosition++;
            } else {
              // If the item is invalid or empty, add it to the oldKeys for removal
              console.log("there");
              oldKeys.push(key);
            }
          });

          // Apply all updates in one  go
          return update(ref(db, "User/lizzy m/toDoList"), updates).then(() => {
            return oldKeys
          });
        } else {
          console.log("No data available to reposition.");
          return Promise.resolve([]); // Return empty array if no data
        }
      })
      .then((oldKeys) => {
        // Remove old keys
        if (oldKeys) {
          if ((oldKeys.length != 1) && (oldKeys[higher - lower] != lower)) {
            oldKeys.shift();
            console.log("shifted");
          }

          if (oldKeys.length > 0) {
            const removalPromises = oldKeys.map((key) =>
              remove(ref(db, `User/lizzy m/toDoList/${key}`))
            );
            return Promise.all(removalPromises);
          }

        }
      })
      .then(() => {
        get(ref(db, "User/lizzy m/toDoList"))
          .then((snapshot) => {
            if (snapshot) {
              console.log("Repositioning and cleanup complete!");
              let offset = 0;
              Object.keys(snapshot.val()).forEach((i) => {
                if (snapshot.child(i.toString()).val().Item !== "") {
                  console.log(i);
                  generateItems(snapshot.child(i.toString()).val().Item, i);
                  items.push(i - offset);
                  console.log(items);
                  if (offset > 0) { offset--; };

                }
                else {
                  console.log("probelmmmmmmmmmmmmmm");
                  console.log(i);
                  console.log(items);
                  offset++;
                }
                console.log("offset: " + offset);
              })
            }
            else {
              console.log("how am i printing??");
            }
          }).catch((error) => {
            console.error(error);
          });

      })
      .catch((error) => {
        console.error("Error repositioning items:", error);
      });

  }


  onAuthStateChanged(auth, (user) => {
    if (true) {
      console.log(user);
      PageLoad();
    } else {
      console.log("error")
    }
  })
</script>

</html>